:PROPERTIES:
:ID:       dc903f89-d756-46f9-9b70-8dda852984d3
:END:
#+title: java loggable annotations

* what is it?

create an Around AOP that logs information about the call.

Allows to trigger on @Loggable annotations at class or method level.
On spring repositories, needs special setup to fight the competing proxying.

* Spring Repository

#+BEGIN_SRC java LoggingRepositoryMethodInterceptor.java :noeval

public class LoggingRepositoryMethodInterceptor implements org.aopalliance.intercept.MethodInterceptor {

    @Override
    public Object invoke(final MethodInvocation methodInvocation) throus Throwable {
        final Class<?> targetClass = methodInvocation.getMethod().getDeclaringClass();
        final Method method = methodInvocation.getMethod();

        final MethodCallLogger methodLogger = new MethodCallLogger(targetClass, method, LoggableCategory.DATABASE);
        methodLogger.logBefore();

        try {
            return methodInvocation.proceed();
        } finally {
            methodLogger.logAfter();
        }
    }
}

#+END_SRC

you enable this with:

#+BEGIN_SRC java :file LoggingRepositoryPostProcessor.java :noeval
public class LoggingRepositoryPostProcessor implements RepositoryProxyPostProcessor {
    @Override
    public void postProcess(final ProxyFactory factory, ....) {
        factory.addAdvice(new LoggingRepositoryMethodInterceptor());
    }
}

#+END_SRC

and

#+BEGIN_SRC java :noeval :file CustomRepositoryFactoryBean.java
public class CustomRepositoryFactoryBean<RepositoryR extends JpaRepository<EntityT, IdI>, EntityT, IdI extends Serializable> extends JpaRepositoryFactoryBean<RepositoryR, EntityT, IdI> {

    public CustomRepositoryFactoryBean(final Class ... repositoryInterface) {
        super(repositoryInterface);
    }

    @Override
    protected RepositoryFactorySupport createRepositoryFactory(final EntityManager entityManager) {
        final RepositoryFactorySupport factory = super.createRepositoryFactory(entityManager);
        factory.addRepositoryProxyPostProcessor(new LoggingRepositoryPostProcessor());
        return factory;
    }


}
#+END_SRC

and on configuration
#+BEGIN_SRC java :file JpaConfiguration.java :noeval

@Configuration
@EnableJpaRepositories(
    repositoryFactoryBeanClass = CustomRepositoryFactoryBean.class
)
public class JpaConfiguration {
    // ....
}
#+END_SRC

