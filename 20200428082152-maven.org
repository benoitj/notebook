#+TITLE: maven

[[file:20200228101727_programming.org][R:programming]]

* Description

* How to
** basic setup
here we put config files, structure, properties
*** setup parent pom
setup a parent pom to share configuration.

In a multimodule project, also define a repo parent in the parent submodule.

** split my work in classifiers
*** prepare pom for publishing
the default pom has both too many things, at the same time, is not the effective pom.
**** start by generating effective pom
The plugin maven-help-plugin to generate the effective pom.

Example config:
#+BEGIN_SRC xml
<?xml version="1.0" encoding="utf-8"?>

<project>
<build>
  <plugins>
    <plugin>
      <groupId>org.apache.maven.plugins</groupId>
      <artifactId>maven-help-plugin</artifactId>
      <version>3.2.0</version>
      <configuration>
        <minimal>true</minimal>
      </configuration>
      <executions>
        <execution>
          <id>generate-effective-pom</id>
          <goals>
            <goal>effective-pom</goal>
          </goals>
          <phase>generate-resources</phase>
          <configuration>
            <output>${project.build.directory}/effective-pom/${project.artifactId}-${project.version}</output>
          </configuration>
        </execution>
      </executions>
    </plugin>
  </plugins>
</build>
</project>
#+END_SRC
**** filter junk out of the effective pom

all you need then is to use xslt to remove unwanted stuff from the pom.

codehaus has the xml-maven-plugin to apply xsl transformation.

#+BEGIN_SRC xml
<?xml version="1.0" encoding="utf-8"?>

<project>
  <build>
    <plugins>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>xml-maven-plugin</artifactId>
        <version>1.0.2</version>
        <executions>
          <execution>
            <goals>
              <goal>transform</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <transformationSets>
            <transformationSet>
              <dir>${project.build.directory}/effective-pom</dir>
              <stylesheet>${project.basedir}/clean-pom.xml</stylesheet>
              <outputDir>${project.build.directory}/pom</outputDir>
            </transformationSet>
          </transformationSets>
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>
#+END_SRC

the transformation file:

#+BEGIN_SRC xml :file clean-pom.xml
<?xml version="1.0" encoding="utf-8"?>

<xsl:transform
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/20001/XMLSchema-instance"
    version="1.0">

  <xsl:output omit-xml-declaration="no" indent="yes"/>
  <xsl:strip-space elements="*"/>
  <xsl:param name="renameElementsNamed"
          select="'|project/parent|project/build|project/licenses|project/properties|project/dependencyManagement|project/url|project/distributionManagement|project/repositories|project/pluginRepositories|project/reporting|'"/>

  <xsl:template match="node()|@*" name="identity">
    <xsl:copy>
      <xsl:apply-templates select="node()|@*"/>
    </xsl:copy>
  </xsl:template>

  <xsl:template match="*">
    <xsl:if test="not(contains($removeElementsNamed, concat('|', name(parent::*), '/', name(), '|')))">
      <xsl:call-template name="identity"/>
    </xsl:if>
  </xsl:template>
</xsl:transform>
#+END_SRC
*** javadoc handling
just use maven-javadoc-plugin

Generate a javadoc classifier.

*** source handling
The plugin maven-source-plugin can generate source jars

#+BEGIN_SRC xml
<?xml version="1.0" encoding="utf-8"?>

<project>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-source-plugin</artifactId>
        <version>3.2.0</version>
        <executions>
          <execution>
            <id>attach-sources</id>
            <goals>
              <goal>jar</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>
#+END_SRC
*** generate custom jars with classifiers

Can be useful to generate pom jars, javadoc jars, documentation jars

You need to configure the maven-jar-plugin for new classifiers

#+BEGIN_SRC xml
<?xml version="1.0" encoding="utf-8"?>

<project>
  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-jar-plugin</artifactId>
        <version>3.1.0</version>
        <executions>
          <execution>
            <id>pom</id>
            <goals>
              <goal>jar</goal>
            </goals>
            <phase>package</phase>
            <configuration>
              <classifier>pom</classifier>
              <classesDirectory>${project.build.directory}/pom</classesDirectory>
            </configuration>
          </execution>
        </executions>
      </plugin>
    </plugins>
  </build>
</project>

#+END_SRC

** TODO releasing/publishing artifacts
** use profiles to turn on/off parts of the build during CI
one strategy is to set "skipX" properties and enable/disable them based on the profile
** aggregate jacoco reports
Make sure you have a coverage jar for each modules. then on the "coverage" module, fetch/unzip in target and run coverage report. Also requires sources.
** aggregated javadoc
1. get all modules/sub-modules to generate source jar
2. in a project, download all source jars, unpack in a folder, than trigger the javadoc plugin to generate.
** TODO generate model code from schema
** TODO Unzip files from jars

* Useful plugins

|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| Plugin                | Description                     | implementation details                                                                    |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| [[https://www.mojohaus.org/versions-maven-plugin/][versions-maven-plugin]] | update version of dependencies. | good to setup ignore on beta, RC, rc, M version. Just need to setup ignoreVersion regex   |
|                       | codehaus.mojo project           | Note: you need to use real versions and not properties for the plugin to work.            |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-help-plugin     | maven pom related tasks         | use the effective-pom to get the effective pom from the project                           |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| xmlm-maven-plugin     | run xsl transformation          |                                                                                           |
|                       | codehaus.org project            |                                                                                           |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-source-plugin   | generate source jars            | attach to jar goal                                                                        |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-javadoc-plugin  | generate javadoc html           |                                                                                           |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-jar-plugin      | create jars                     | you can create custom classifiers (like pom or coverage-reports)                          |
|                       |                                 | you can also create new manifest entries like build number                                |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-surefire-plugin | run unit tests                  |                                                                                           |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-failsafe-plugin | run integration tests           | good practice to match IntegrationTest instead of IT                                      |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| jacoco-maven-plugin   | generate coverage reports       | prepare-agent:                                                                            |
|                       |                                 | create different execution configuration for failsafe/surefiregood practice               |
|                       |                                 | to set a different destination exec file so it does not overlap                           |
|                       |                                 | merge:                                                                                    |
|                       |                                 | then a 3rd execution to merge these exec files to generate a "final" exec                 |
|                       |                                 | do the same in the aggregated project, merge all jacoco reports jar exec files.           |
|                       |                                 | report: run to verify output                                                              |
|                       |                                 | check-coverage: run to fail if lower than X%                                              |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| maven-git-code-format | install hooks to implement      |                                                                                           |
| com.cosium.codehaus   | google code formatting          |                                                                                           |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| pmd                   | Static code analysis            | check and check-cpd goals are to be used to get both pmd checks and copy paste detection  |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| Spotbugs              | Static code analysys + security | enable plugin findsecbugs-plugin to get security checks                                   |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| Pitest                | permutation test                | Validates ineffective test suite. needs high coverage. unclear how to make work w/ java11 |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| Jacoco                | Code coverage reports           |                                                                                           |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
| jolt                  | Transform json to json          | can be used to transform schemas for code generation                                      |
|-----------------------+---------------------------------+-------------------------------------------------------------------------------------------|
|                       |                                 |                                                                                           |
