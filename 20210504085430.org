:PROPERTIES:
:ID:       fab625ca-0394-49ff-a3e5-7c9983eae1ea
:END:
#+title: org mode rest client

* within org mode

** using json test
#+begin_src restclient
GET http://ip.jsontest.com
#+end_src

** fetch auth

#+begin_src restclient
GET https://httpbin.org/response-headers?Authorization=bar
-> run-hook (restclient-set-var ":auth" (cdr (assq 'Authorization (json-read))))
#+end_src

#+RESULTS:
#+BEGIN_SRC js
{
  "Authorization": "bar",
  "Content-Length": "95",
  "Content-Type": "application/json"
}

// GET https://httpbin.org/response-headers?Authorization=bar
// HTTP/1.1 200 OK
// Date: Sat, 08 May 2021 06:10:00 GMT
// Content-Type: application/json
// Content-Length: 95
// Connection: keep-alive
// Server: gunicorn/19.9.0
// Authorization: bar
// Access-Control-Allow-Origin: *
// Access-Control-Allow-Credentials: true
// Request duration: 0.023969s
#+END_SRC

** run with auth var

#+begin_src restclient
# now two
GET https://httpbin.org/response-headers?Authorization2=:auth
#+end_src

#+RESULTS:
#+BEGIN_SRC js
{
  "Authorization2": "bar",
  "Content-Length": "96",
  "Content-Type": "application/json"
}

// GET https://httpbin.org/response-headers?Authorization2=bar
// HTTP/1.1 200 OK
// Date: Sat, 08 May 2021 06:10:03 GMT
// Content-Type: application/json
// Content-Length: 96
// Connection: keep-alive
// Server: gunicorn/19.9.0
// Authorization2: bar
// Access-Control-Allow-Origin: *
// Access-Control-Allow-Credentials: true
// Request duration: 0.023143s
#+END_SRC
* using <file>.http files

#+begin_src restclient :file test.http
# -*- restclient -*-

# getting auth
GET https://httpbin.org/response-headers?Authorization=foo
-> run-hook (restclient-set-var ":auth" (cdr (assq 'Authorization (json-read))))

# now lets use that auth
GET https://httpbin.org/response-headers?Authorization=:auth

# now two
GET https://httpbin.org/response-headers?Authorization2=:auth

# test
GET http://httpbin.org/response-headers?origin=1.2.3.4
-> run-hook (restclient-set-var ":my-ip" (cdr (assq 'origin (json-read))))

# ok
#:my-ip = 4.3.2.1
GET http://httpbin.org/response-headers?ip=:my-ip

#+end_src

** TODO how do I get -> jq-set-var to work?

